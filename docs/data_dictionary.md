## Словарь полей и правила (domain rules)

### Термины и статусы
- **Поверка/калибровка**: метрологическая операция над средством измерений (СИ). В проекте унифицируется сущностью **check**.
- **Тип операции (`check_type`)**:
  - `kind = VERIFICATION` — поверка
  - `kind = CALIBRATION` — калибровка
- **Результат события (`check_event.result_status`)**:
  - `PASSED` — годен (операция успешна, СИ пригодно к применению)
  - `FAILED` — не годен (СИ непригодно/не прошло)
  - `CANCELED` — отменено (событие не состоялось, результата по пригодности нет)
  - (опционально) `CONDITIONAL` — годен условно (если нужно отдельным правилом)
- **Следующая дата (`next_due_date`)**: дата следующей обязательной операции (поверки/калибровки) для данного СИ и типа операции.

### Правила вычисления сроков
- **Межповерочный интервал** хранится в `check_requirement.interval_months` (целое число месяцев, строго > 0).
- **Льготный период** (если используется) — `check_requirement.grace_days` (>= 0), применяется при отчётах (например, предупреждения до фактической просрочки).
- **Вычисление `next_due_date`**:
  - если `result_status = PASSED` (или разрешённый статус) → `next_due_date = check_date + interval_months`
  - если `result_status IN (FAILED, CANCELED)` → `next_due_date = NULL`
  - интервал берётся из `check_requirement` для пары (`instrument_model`, `check_type`)
  - правило консистентности закрепляется **триггером/функцией** на `check_event`

### Правила жизненного цикла прибора
- **Статус прибора (`instrument.status`)**:
  - `ACTIVE` — в эксплуатации
  - `IN_REPAIR` — в ремонте
  - `DECOMMISSIONED` — выведен из эксплуатации (без замены)
  - `REPLACED` — выведен и заменён другим прибором
- **История статусов** ведётся в `instrument_status_history` с `valid_from/valid_to`.
- Инвариант: у прибора может быть **ровно один «открытый»** статус в истории (`valid_to IS NULL`).

### Документы и протоколы
- **Протокол** (номер/атрибут): `check_event.protocol_no` (строка, не обязателен для всех типов).
- **Документы** хранятся ссылками:
  - `document.storage_ref` — внешний идентификатор/URI/путь в DMS/объектном хранилище
  - сами файлы не храним в БД
- Привязка документов к событию: `check_event_document` (many-to-many).

### План/факт
- **План (`check_plan`)**: запланированная операция с целевой датой `due_date`.
- **Факт (`check_event`)**: реально проведённая операция.
- Кардинальность: 1 план → 0..1 факт (одна запись факта может ссылаться на план).
- Инвариант: если `check_event.check_plan_id` заполнен — он **уникален** (один факт на один план).

### Аудит
- **Аудит** фиксирует изменения в ключевых таблицах (инструменты, планы, события, требования, документы).
- Формат: `audit_log` содержит время, пользователя БД (`db_user`), действие, таблицу, PK (если применимо), старую и новую строки (JSONB).


